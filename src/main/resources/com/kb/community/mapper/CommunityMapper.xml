<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kb.community.mapper.CommunityMapper">

    <!--  커뮤니티 글 전체 조회 (작성자 닉네임 포함) -->
    <select id="findAll" resultType="com.kb.community.dto.response.CommunityListDTO">
        SELECT c.COMMUNITY_ID communityId, c.TAG tag, c.TITLE title, u.NICKNAME nickname, c.CREATED_AT createdAt, c.VIEWS views
        FROM COMMUNITY c JOIN USER u
        ON c.USER_ID = u.USER_ID
        ORDER BY c.CREATED_AT DESC
    </select>

    <!--  커뮤니티 글 ID를 사용하여 상세 글 조회 (작성자 닉네임 포함)  -->
    <select id="findById" resultType="com.kb.community.dto.response.CommunityDetailDTO" parameterType="long">
        SELECT c.COMMUNITY_ID communityId, c.USER_ID userId, u.NICKNAME nickname, u.PIC userPic, c.TAG tag, c.TITLE title, c.CREATED_AT createdAt, c.VIEWS views
        FROM COMMUNITY c JOIN USER u
        ON c.USER_ID = u.USER_ID
        WHERE c.COMMUNITY_ID = #{communityId}
    </select>

    <!--  커뮤니티 글 작성 - 저장 후 해당 글ID 리턴 -->
    <insert id="save" parameterType="com.kb.community.dto.request.CommunityPostDTO" useGeneratedKeys="true" keyProperty="communityId">
        INSERT INTO COMMUNITY (USER_ID, TITLE, CONTENT, TAG, PICS) VALUES (#{userId}, #{title}, #{content}, #{tag}, #{pics})

        <selectKey keyProperty="communityId" resultType="long" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!--  커뮤니티 글 삭제  -->
    <delete id="delete" parameterType="long">
        DELETE FROM COMMUNITY WHERE COMMUNITY_ID = #{communityId}
    </delete>

    <!--  커뮤니티 글 수정  -->
    <update id="update" parameterType="com.kb.community.dto.request.CommunityModifyDTO">
        UPDATE COMMUNITY
        SET TITLE = #{title}, CONTENT = #{content}, TAG = #{tag}, PICS = #{pics}, UPDATED_AT = now()
        WHERE COMMUNITY_ID = #{communityId}
    </update>

    <!--  커뮤니티 조회수 업데이트  -->
    <update id="updateViews">
        UPDATE COMMUNITY
        SET VIEWS = #{views}
        WHERE COMMUNITY_ID = #{communityId}
    </update>

</mapper>
